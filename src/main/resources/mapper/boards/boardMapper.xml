<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.zipcheck.boards.mapper.BoardMapper">

    <!-- ========================================================= -->
    <!-- ResultMap -->
    <!-- ========================================================= -->
    <resultMap id="boardResultMap" type="com.ssafy.zipcheck.boards.vo.Boards">
        <id property="boardId" column="board_id"/>
        <result property="title" column="title"/>
        <result property="category" column="category"/>
        <result property="content" column="content"/>
        <result property="hit" column="hit"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="userId" column="users_user_id"/>
        <result property="visible" column="visible"/>
        <result property="nickname" column="nickname"/>
        <result property="likeCount" column="like_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="isLiked" column="is_liked"/>
    </resultMap>

    <!-- ========================================================= -->
    <!-- 게시글 저장 -->
    <!-- ========================================================= -->
    <insert id="save" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO boards (title, category, content, hit, created_at, users_user_id, visible)
        VALUES (#{title}, #{category}, #{content}, 0, NOW(), #{userId}, true)
    </insert>

    <!-- ========================================================= -->
    <!-- 게시글 전체 목록 -->
    <!-- ========================================================= -->
    <select id="findAll" resultMap="boardResultMap">
        SELECT
        b.*,

        CASE
        WHEN u.status = 0 THEN '탈퇴한 사용자'
        ELSE u.nickname
        END AS nickname,

        (SELECT COUNT(*)
        FROM likes l
        WHERE l.boards_board_id = b.board_id) AS like_count,

        (SELECT COUNT(*)
        FROM comments c
        WHERE c.board_id = b.board_id
        AND c.visible = 1) AS comment_count,

        CASE
        WHEN #{userId} IS NULL THEN 0
        WHEN EXISTS (
        SELECT 1
        FROM likes l2
        WHERE l2.boards_board_id = b.board_id
        AND l2.users_user_id = #{userId}
        ) THEN 1
        ELSE 0
        END AS is_liked

        FROM boards b
        JOIN users u ON b.users_user_id = u.user_id
        WHERE b.visible = 1

        <choose>
            <when test="order == 'likes'">
                ORDER BY like_count DESC, b.created_at DESC
            </when>
            <otherwise>
                ORDER BY b.created_at DESC
            </otherwise>
        </choose>
    </select>

    <!-- ========================================================= -->
    <!-- 게시글 상세 -->
    <!-- ========================================================= -->
    <select id="findById" resultMap="boardResultMap">
        SELECT
            b.*,

            CASE
                WHEN u.status = 0 THEN '탈퇴한 사용자'
                ELSE u.nickname
                END AS nickname,

            (SELECT COUNT(*)
             FROM likes l
             WHERE l.boards_board_id = b.board_id) AS like_count,

            (SELECT COUNT(*)
             FROM comments c
             WHERE c.board_id = b.board_id
               AND c.visible = 1) AS comment_count,

            CASE
                WHEN #{userId} IS NULL THEN 0
                WHEN EXISTS (
                    SELECT 1
                    FROM likes l2
                    WHERE l2.boards_board_id = b.board_id
                      AND l2.users_user_id = #{userId}
                ) THEN 1
                ELSE 0
                END AS is_liked

        FROM boards b
                 JOIN users u ON b.users_user_id = u.user_id
        WHERE b.board_id = #{boardId}
    </select>

    <!-- ========================================================= -->
    <!-- 내가 쓴 게시글 -->
    <!-- ========================================================= -->
    <select id="findByUserId" resultMap="boardResultMap">
        SELECT
            b.*,

            CASE
                WHEN u.status = 0 THEN '탈퇴한 사용자'
                ELSE u.nickname
                END AS nickname,

            (SELECT COUNT(*)
             FROM likes l
             WHERE l.boards_board_id = b.board_id) AS like_count,

            (SELECT COUNT(*)
             FROM comments c
             WHERE c.board_id = b.board_id
               AND c.visible = 1) AS comment_count,

            CASE
                WHEN EXISTS (
                    SELECT 1
                    FROM likes l2
                    WHERE l2.boards_board_id = b.board_id
                      AND l2.users_user_id = #{userId}
                ) THEN 1
                ELSE 0
                END AS is_liked

        FROM boards b
                 JOIN users u ON b.users_user_id = u.user_id
        WHERE b.users_user_id = #{userId}
          AND b.visible = 1
        ORDER BY b.created_at DESC
    </select>

    <!-- ========================================================= -->
    <!-- 게시글 수정 -->
    <!-- ========================================================= -->
    <update id="update">
        UPDATE boards
        SET title = #{title},
            category = #{category},
            content = #{content},
            updated_at = NOW()
        WHERE board_id = #{boardId}
    </update>

    <!-- ========================================================= -->
    <!-- 게시글 삭제 -->
    <!-- ========================================================= -->
    <delete id="delete">
        DELETE FROM boards WHERE board_id = #{boardId}
    </delete>

    <!-- ========================================================= -->
    <!-- 조회수 증가 -->
    <!-- ========================================================= -->
    <update id="incrementHit">
        UPDATE boards SET hit = hit + 1 WHERE board_id = #{boardId}
    </update>

</mapper>
