<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.zipcheck.listings.mapper.ListingMapper">

    <!-- ========================================================= -->
    <!-- ResultMap -->
    <!-- ========================================================= -->
    <resultMap id="ListingResponseMap"
               type="com.ssafy.zipcheck.listings.dto.ListingResponse">

        <id property="dealNo" column="deal_no"/>

        <result property="aptSeq" column="apt_seq"/>
        <result property="aptName" column="apt_nm"/>
        <result property="jibun" column="jibun"/>
        <result property="roadNm" column="road_nm"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>

        <result property="aptDong" column="apt_dong"/>
        <result property="floor" column="floor"/>
        <result property="excluUseAr" column="exclu_use_ar"/>
        <result property="dealAmount" column="deal_amount"/>

        <!-- 찜 여부 -->
        <result property="isFavorite" column="is_favorite"/>
    </resultMap>

    <!-- ========================================================= -->
    <!-- Dynamic Filter -->
    <!-- ========================================================= -->
    <sql id="listingFilter">
        <if test="request.sidoName != null and request.sidoName != ''">
            AND dc.sido_name = #{request.sidoName}
        </if>
        <if test="request.gugunName != null and request.gugunName != ''">
            AND dc.gugun_name = #{request.gugunName}
        </if>
        <if test="request.dongName != null and request.dongName != ''">
            AND dc.dong_name = #{request.dongName}
        </if>

        <if test="request.minArea != null">
            AND hd.exclu_use_ar &gt;= #{request.minArea}
        </if>
        <if test="request.maxArea != null">
            AND hd.exclu_use_ar &lt;= #{request.maxArea}
        </if>

        <if test="request.minPrice != null">
            AND hd.deal_amount_num &gt;= #{request.minPrice}
        </if>
        <if test="request.maxPrice != null">
            AND hd.deal_amount_num &lt;= #{request.maxPrice}
        </if>
    </sql>

    <!-- ========================================================= -->
    <!-- Select : Listing + isFavorite -->
    <!-- ========================================================= -->
    <select id="findListings" resultMap="ListingResponseMap">

        SELECT
        hd.no AS deal_no,

        hi.apt_seq,
        hi.apt_nm,
        hi.jibun,
        hi.road_nm,
        hi.build_year,
        hi.latitude,
        hi.longitude,

        hd.apt_dong,
        hd.floor,
        hd.exclu_use_ar,
        hd.deal_amount,

        CASE
        WHEN i.interest_id IS NULL THEN FALSE
        ELSE TRUE
        END AS is_favorite

        FROM housedeals hd
        JOIN houseinfos hi
        ON hd.apt_seq = hi.apt_seq
        JOIN dongcodes dc
        ON dc.sgg_prefix = hi.sgg_cd
        AND dc.dong_name = hi.umd_nm

        LEFT JOIN interests i
        ON i.deal_no = hd.no
        AND i.user_id = #{userId}

        WHERE 1=1
        <include refid="listingFilter"/>

        ORDER BY hd.no DESC
        LIMIT #{request.size}
        OFFSET #{request.offset}
    </select>

</mapper>
