<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.zipcheck.sticker.mapper.StickerMapper">

    <insert id="insertSticker" parameterType="com.ssafy.zipcheck.sticker.vo.Sticker">
        INSERT INTO sticker (user_id, apt_id, sticker_type_id, description)
        VALUES (#{userId}, #{aptId}, #{stickerTypeId}, #{description})
    </insert>

    <select id="findStickerById" parameterType="long" resultType="com.ssafy.zipcheck.sticker.vo.Sticker">
        SELECT sticker_id, user_id, apt_id, sticker_type_id, description, created_at
        FROM sticker
        WHERE sticker_id = #{stickerId}
    </select>

    <select id="findStickersByAptId" parameterType="string" resultType="com.ssafy.zipcheck.sticker.dto.StickerResponse">
        SELECT
            s.sticker_id AS stickerId,
            s.user_id AS userId,
            u.nickname AS userNickname,
            s.apt_id AS aptId,
            s.sticker_type_id AS stickerTypeId,
            st.name AS stickerTypeName,
            s.description,
            s.created_at AS createdAt
        FROM
            sticker s
        JOIN
            users u ON s.user_id = u.user_id
        JOIN
            sticker_type st ON s.sticker_type_id = st.sticker_type_id
        WHERE
            s.apt_id = #{aptId}
        ORDER BY
            s.created_at DESC
    </select>

    <delete id="deleteSticker" parameterType="long">
        DELETE FROM sticker WHERE sticker_id = #{stickerId}
    </delete>

    <select id="findUserIdByStickerId" parameterType="long" resultType="java.lang.Integer">
        SELECT user_id
        FROM sticker
        WHERE sticker_id = #{stickerId}
    </select>

    <select id="findStickerTypeIdByName" parameterType="string" resultType="java.lang.Integer">
        SELECT sticker_type_id
        FROM sticker_type
        WHERE name = #{name}
    </select>

    <select id="findStickerEmotionsByBounds"
            parameterType="com.ssafy.zipcheck.sticker.dto.StickerMapQueryRequest"
            resultType="com.ssafy.zipcheck.sticker.dto.StickerMapRow">
        SELECT
            s.apt_id AS aptId,
            hi.latitude AS latitude,
            hi.longitude AS longitude,
            s.sticker_type_id AS stickerTypeId,
            st.emoji AS emoji,
            COUNT(*) AS count
        FROM sticker s
                 JOIN houseinfos hi ON s.apt_id = hi.apt_seq
                 JOIN sticker_type st ON s.sticker_type_id = st.sticker_type_id
        WHERE hi.latitude BETWEEN #{minLatitude} AND #{maxLatitude}
          AND hi.longitude BETWEEN #{minLongitude} AND #{maxLongitude}
        GROUP BY s.apt_id, hi.latitude, hi.longitude, s.sticker_type_id, st.emoji
        ORDER BY s.apt_id, s.sticker_type_id
    </select>

</mapper>
