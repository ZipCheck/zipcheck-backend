<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.zipcheck.interests.mapper.InterestMapper">

    <!-- ========================================================= -->
    <!-- ResultMap -->
    <!-- ========================================================= -->
    <resultMap id="InterestResponseMap"
               type="com.ssafy.zipcheck.interests.dto.InterestResponse">

        <!-- interest -->
        <id property="interestId" column="interest_id"/>
        <result property="dealNo" column="deal_no"/>
        <result property="createdAt" column="created_at"/>

        <!-- houseinfos -->
        <result property="aptSeq" column="apt_seq"/>
        <result property="aptName" column="apt_nm"/>
        <result property="jibun" column="jibun"/>
        <result property="roadNm" column="road_nm"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>

        <!-- housedeals -->
        <result property="aptDong" column="apt_dong"/>
        <result property="floor" column="floor"/>
        <result property="dealYear" column="deal_year"/>
        <result property="dealMonth" column="deal_month"/>
        <result property="dealDay" column="deal_day"/>
        <result property="excluUseAr" column="exclu_use_ar"/>
        <result property="dealAmount" column="deal_amount"/>

        <!-- UI 확장 -->
        <result property="hasSticker" column="has_sticker"/>
    </resultMap>

    <!-- ========================================================= -->
    <!-- Insert -->
    <!-- ========================================================= -->
    <insert id="addInterest"
            parameterType="com.ssafy.zipcheck.interests.vo.Interest">
        INSERT INTO interests (user_id, deal_no, created_at)
        VALUES (#{userId}, #{dealNo}, NOW())
    </insert>

    <!-- ========================================================= -->
    <!-- Delete -->
    <!-- ========================================================= -->
    <delete id="deleteByUserAndDeal">
        DELETE FROM interests
        WHERE user_id = #{userId}
          AND deal_no = #{dealNo}
    </delete>

    <!-- ========================================================= -->
    <!-- Exists Check -->
    <!-- ========================================================= -->
    <select id="findByUserIdAndDealNo"
            resultType="com.ssafy.zipcheck.interests.vo.Interest">
        SELECT
            interest_id,
            user_id,
            deal_no,
            created_at
        FROM interests
        WHERE user_id = #{userId}
          AND deal_no = #{dealNo}
    </select>

    <!-- ========================================================= -->
    <!-- Dynamic WHERE -->
    <!-- ========================================================= -->
    <sql id="interestFilter">
        <if test="request.sidoName != null and request.sidoName != ''">
            AND dc.sido_name = #{request.sidoName}
        </if>
        <if test="request.gugunName != null and request.gugunName != ''">
            AND dc.gugun_name = #{request.gugunName}
        </if>
        <if test="request.dongName != null and request.dongName != ''">
            AND dc.dong_name = #{request.dongName}
        </if>

        <if test="request.minArea != null">
            AND hd.exclu_use_ar &gt;= #{request.minArea}
        </if>
        <if test="request.maxArea != null">
            AND hd.exclu_use_ar &lt;= #{request.maxArea}
        </if>

        <if test="request.minPrice != null">
            AND hd.deal_amount_num &gt;= #{request.minPrice}
        </if>
        <if test="request.maxPrice != null">
            AND hd.deal_amount_num &lt;= #{request.maxPrice}
        </if>
    </sql>

    <!-- ========================================================= -->
    <!-- Select : Interest List -->
    <!-- ========================================================= -->
    <select id="findInterestsByUser"
            resultMap="InterestResponseMap">

        SELECT
        i.interest_id,
        i.deal_no,
        i.created_at,

        hi.apt_seq,
        hi.apt_nm,
        hi.jibun,
        hi.road_nm,
        hi.build_year,
        hi.latitude,
        hi.longitude,

        hd.apt_dong,
        hd.floor,
        hd.deal_year,
        hd.deal_month,
        hd.deal_day,
        hd.exclu_use_ar,
        hd.deal_amount

        FROM interests i
        JOIN housedeals hd
        ON i.deal_no = hd.no
        JOIN houseinfos hi
        ON hd.apt_seq = hi.apt_seq
        JOIN dongcodes dc
        ON dc.sgg_prefix = hi.sgg_cd
        AND dc.dong_name = hi.umd_nm

        WHERE i.user_id = #{userId}

        <include refid="interestFilter"/>

        ORDER BY i.created_at DESC
        LIMIT #{request.size}
        OFFSET #{request.offset}
    </select>

    <!-- ========================================================= -->
    <!-- Select : Count -->
    <!-- ========================================================= -->
    <select id="countInterestsByUser" resultType="int">

        SELECT COUNT(i.interest_id)

        FROM interests i
        JOIN housedeals hd
        ON i.deal_no = hd.no
        JOIN houseinfos hi
        ON hd.apt_seq = hi.apt_seq
        JOIN dongcodes dc
        ON dc.sgg_prefix = hi.sgg_cd
        AND dc.dong_name = hi.umd_nm

        WHERE i.user_id = #{userId}

        <include refid="interestFilter"/>

    </select>

</mapper>
